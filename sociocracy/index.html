<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130646721-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-130646721-1');
</script>
<meta charset="utf-8">
<title>Sociocracy Org Chart Maker</title>
<meta name="description" content="A rough and simple tool for generating sociocracy org charts.">
<link rel="stylesheet" type="text/css" href="normalize.css" />
<style>
html *
{
   color: rgb(77, 77, 77) !important;
   font-family: Helvetica, Arial, sans-serif !important;
   
}
body{
    background: #eee;   
    display: grid;
    grid-template-columns: 600px minmax(200px,300px) minmax(250px,400px);
    grid-template-rows: 50px 1fr;
    column-gap:20px;
    row-gap:20px;
    padding:20px; 
    /* font-family: "Tahoma, Geneva, sans-serif"; */
}

.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

circle.node {
  fill: rgba(236, 234, 234, 1);
  stroke: #fff;
  stroke-width: 1.5px;
}
button#generate{
  grid-column: 1;
  grid-row: 1;
  align-self: stretch;
}
button#redraw{
  grid-column: 2;
  grid-row: 1;
  align-self: stretch;
}

form#jsonform{
  grid-column: 2;
  grid-row: 2 / 5;
  align-self: stretch;
  display: grid;
  row-gap:10px;
  grid-template-rows: 1fr 1fr;
}
textarea#jsontextarea{
  grid-column: 1;
  grid-row: 1;
  align-self: stretch;
  line-height: 1.5em;
  font-size: 0.8em;

}
textarea#jsontextarea2{
  grid-column: 1;
  grid-row: 2;
  align-self: stretch;
  line-height: 1.5em;
  font-size: 0.8em;

}
svg {
border-width:0px;
background: #fff;
grid-column: 1 / 2;
  grid-row: 2 / 2;
}
li {
  margin-bottom:10px;
}
section.info{
    font-size: 1em;
    line-height: 1.5em;
}
section.info > h1{
  font-size: 1.5em;

    margin-top:0px;
}
.ps{
    font-size: 0.7em;
    line-height: 1.7em;

}
</style>
<script src="d3.min.js"></script>
<script src="d3-save-svg-min.js"></script>

<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>

<meta property="og:type" content="product">
<meta property="og:title" content="Sociocracy Org Chart Maker">
<meta property="og:description" content="A rough and simple tool for generating sociogracy org charts.">
<meta property="og:url" content="https://bitbutter.github.io/sociocracy/">
<meta property="og:image" content="diagram.png">

</head>

<body>
        <button id="generate">Save as SVG</button>
        <button id="redraw">Redraw</button>
        <form id="jsonform">
            <textarea id="jsontextarea"></textarea>
            <textarea id="jsontextarea2"></textarea>
        </form>
        <section class="info">
            <h1>Sociocracy Org Chart Maker</h1>
            <ul>
              <li>Edit the JSON objects in the two text fields. Click 'Redraw' when done.</li>
              <li>Drag the circles around to your satisfaction.</li>
              <li>Click 'Save as SVG' to export as an SVG image; for further editing in a vector graphics app, or for direct use online.</li>
              </ul>
            <p>The top field describes the nodes (circles). You can ignore the x and y properties.</p>
            <p>The lower field describes the links between the circles. The "type" property allows you to specify whether the link is "double" (delegate plus leader) or single. The "source" and "target" properties need to match existing "id" values in the top field.</p>
            <p class="ps">Works as intended in Chrome 70.0.3538.102. No guarantees about any other browser. Uses the <a href="https://d3js.org">D3 library</a>. I hacked this together because I couldn't find a tool to speed up making/modifying the circle diagrams for <a href="https://www.sociocracyforall.org/sociocracy/">sociocratic</a> organisations. My email: info at redshift media dot com.</p>
        </section>
        <script>
                var nodesObj;
                var linksObj;
                // Setup SVG
                var width = 600, height = 600;
                var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height);

                
                // Setup initial data
                nodesObj = [
                    {"id": "Mission Circle", "radius": 50, x:0,y:0},
                    {"id": "School Circle", "radius": 100,x:0,y:0},
                    {"id": "Parents' Circle", "radius": 70,x:0,y:0},
                    {"id": "Staff Circle", "radius": 50,x:0,y:0},
                    {"id": "Mediation Circle", "radius": 75,x:0,y:0}
                  ];

                linksObj = [
                    { "source": "Mission Circle", "target": "School Circle", "type": "double" },
                    { "source": "Mission Circle", "target": "Parents' Circle", "type": "double" },
                    { "source": "Mission Circle", "target": "Staff Circle", "type": "single" },
                    { "source": "School Circle", "target": "Mediation Circle", "type": "double" }
                  ]
                var simulation;

                function doIt(){
                svgPrepare();
                updateTextAreaFromObjects();
                updateLinksTextArea(linksObj);
                // Force simulation
                
                const forceX = d3.forceX(width / 2).strength(1)
                const forceY = d3.forceY(height / 2).strength(1)
                
                simulation = d3.forceSimulation()
                  .force('charge', d3.forceManyBody().strength(-50))
                  .force('center', d3.forceCenter(width / 2, height / 2))
                  .force('collision', d3.forceCollide().radius(function(d) {return d.radius}))
                  .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(180))
                  .on("tick", ticked);

                simulation.nodes(nodesObj);
                simulation.force("link").links(linksObj);
         

                // draw svg shapes

                var link = d3.select("#links").selectAll(".link"),
                    node = d3.select("#nodes").selectAll(".node"),
                    text = d3.select("#text").selectAll("text");
                
                  link = link
                    .data(linksObj)
                    .enter().append("path")
                      .attr("class", "link")
                      .attr("marker-end", "url(#endArrow)")
                      .style("stroke-linecap", "round");  // stroke-linecap type

                
                  node = node
                    .data(nodesObj)
                    .enter().append("circle")
                      .attr("class", "node")
                      .attr("r", function(d) { return d.radius; })
                      .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));
                    
                    text = text
                        .data(nodesObj)
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x; })
                        .attr("y", function(d) { return d.y; })
                        .text( function (d) { return d.id; })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", function(d){return fontSize(d.id,d.radius);})
                        .attr("alignment-baseline","middle")
                        .attr("text-anchor","middle");
                
                // Drag callbacks
                
                function fontSize(s,rad){
                  var n = (250 / s.length)*(rad/100);
                  n = Math.max(n, 9);
                  n = Math.min(n,20);

                  return ""+n+"px";
                }
                function dragstarted(d) {
                  d3.select(this).raise().classed("active", true);
                }
                
                function dragged(d) {
                  d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
                  ticked();
                }
                
                function dragended(d) {
                  d3.select(this).classed("active", false);
                  updateTextAreaFromObjects();
                }
                
                function ticked() {

                  node.attr("cx", function(d) { return d.x; })
                      .attr("cy", function(d) { return d.y; });
                  text.attr("x", function(d) { return d.x; })
                      .attr("y", function(d) { return d.y; });
                  link.attr("d", function(d) {
                      // Total difference in x and y from source to target
                      diffX = parseFloat(d.target.x - d.source.x);
                      diffY = parseFloat(d.target.y - d.source.y);
          
                      // Length of path from center of source node to center of target node
                      pathLength = Math.sqrt((diffX * diffX) + (diffY * diffY));
          
                      // if we define dx=x2-x1 and dy=y2-y1, then the normals are (-dy, dx) and (dy, -dx).
                      var normalX = (-1*diffY) / pathLength;
                      var normalY = diffX / pathLength;
          
                      var offsetAmount=5.0;
                      xPerpOffset=normalX*offsetAmount;
                      yPerpOffset=normalY*offsetAmount;
          
                      var linkPadding = 5;
                      // x and y distances from center to outside edge of target node
                      offsetXt = (diffX * (d.target.radius + linkPadding)) / pathLength;
                      offsetYt = (diffY * (d.target.radius + linkPadding)) / pathLength;
                      offsetXs = (diffX * (d.source.radius + linkPadding)) / pathLength;
                      offsetYs = (diffY * (d.source.radius + linkPadding)) / pathLength;
                      var oStringd = "M " + d.source.x+ ",\n" + d.source.y + "\nL" + (d.target.x - offsetXt) + ",\n" + (d.target.y - offsetYt);
                      var dStringd = "\n\n M " + (d.source.x+xPerpOffset+offsetXs)+ ",\n" + d.source.y+yPerpOffset+offsetYs + "\nL" + ((d.target.x+xPerpOffset) - offsetXt) + ",\n" + ((d.target.y+yPerpOffset) - offsetYt);
          
                      var dString="";
                      if (d.type=="single"){
                          // draw a single link
                          dString = "M" + (d.source.x+offsetXs)+ "," + (d.source.y+offsetYs) + "L" + ((d.target.x) - offsetXt) + "," + ((d.target.y) - offsetYt);
                      } else {
                          // draw a double link
                          dString = "M" + (d.source.x+xPerpOffset+offsetXs)+ "," + (d.source.y+yPerpOffset+offsetYs) + "L" + ((d.target.x+xPerpOffset) - offsetXt) + "," + ((d.target.y+yPerpOffset) - offsetYt);
                          dString += "M" + (d.source.x-xPerpOffset+offsetXs)+ "," + (d.source.y-yPerpOffset+offsetYs) + "L" + ((d.target.x-xPerpOffset) - offsetXt) + "," + ((d.target.y-yPerpOffset) - offsetYt);
                      }
                      // alert (oStringd + dStringd);
                      return dString;
                    }).attr("marker-end", "url(#endArrow)").attr("marker-start", "url(#startArrow)");
                }
            }
                d3.select('button#generate').on('click', function() {
                  var config = {
                    filename: 'circles',
                  }
                  d3_save_svg.save(d3.select('svg').node(), config);
                });
                d3.select('button#redraw').on('click', function() {
                    try {
                    nodesObj = JSON.parse(d3.select("#jsontextarea").property('value')); // this is how you parse a string into JSON 
                    linksObj = JSON.parse(d3.select("#jsontextarea2").property('value')); // this is how you parse a string into JSON 
                    svg.selectAll("*").remove();
                    simulation.stop();
                    doIt(true);
                    } catch (ex) {
                    console.error(ex);
                    }
                });
                
                function updateObjectFromTextArea(){

                  var s = d3.select("#jsontextarea").property('value')
                  nodesObj = JSON.parse(d3.select("#jsontextarea").property('value')); // this is how you parse a string into JSON 
                  linksObj = JSON.parse(d3.select("#jsontextarea2").property('value')); // this is how you parse a string into JSON 

                }
                function updateTextAreaFromObjects(){
                  var myJSON = JSON.stringify(nodesObj,replacer,2);
                  d3.select("#jsontextarea").text(myJSON);
                }
                function updateLinksTextArea(o){
                  var myJSON = JSON.stringify(o,replacer,2);
                  d3.select("#jsontextarea2").text(myJSON);
                }

                function svgPrepare(){
                  var svg = d3.select("svg"),
                    width = +svg.attr("width"),
                    height = +svg.attr("height");
                    var svglinks = svg.append("g").attr("id", "links");
                    var svgnodes = svg.append("g").attr("id", "nodes");
                    var svgtext = svg.append("g").attr("id", "text");
                
                // Per-type markers, as they don't inherit styles.
                svg.append("defs").selectAll("marker")
                    .data(["endArrow"])
                  .enter().append("marker")
                    .attr("id", function(d) { return d; })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 5)
                    .attr("refY", 0)
                    .attr("fill","#666")
                
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("path")
                    .attr("d", "M0,-5L10,0L0,5");
                
                svg.append("defs").selectAll("marker")
                    .data(["startArrow"])
                  .enter().append("marker")
                    .attr("id", function(d) { return d; })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 5)
                    .attr("refY", 0)
                    .attr("fill","#666")
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("path")
                  .attr("d", "M10,-5L0,0L10,5");
                }

                function replacer(key,value)
                {
                    if (key=="vx"||key=="vy"||key=="index") return undefined;
                    else if (key=="privateProperty2") return undefined;
                    else return value;
                }

                doIt();
                </script>
</body>