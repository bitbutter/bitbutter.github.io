<!DOCTYPE html>
<meta charset="utf-8">
<style>
body{
    background: #eee;   
    display: grid;
    grid-template-columns: [first] 800px [line2] auto [end];
    grid-template-rows: [row1-start] 100px [row1-end] 820px [third-line] auto [last-line];

}
.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

circle.node {
  fill: rgba(236, 234, 234, 1);
  stroke: #fff;
  stroke-width: 1.5px;
}

/* text {
  font: 14px sans-serif;
  pointer-events: none;
} */
button#generate{
  grid-column: 1 / 2;
  grid-row: 1 / 1;
}
button#redraw{
  grid-column: 2 / 3;
  grid-row: 1 / 1;
}
textarea#jsontextarea{
  grid-column: 2 / 3;
  grid-row: 2 / 3;
  width:100%;
  height:50%;
}
textarea#jsontextarea2{
  grid-column: 2 / 3;
  grid-row: 2 / 3;
  width:100%;
  height:50%;
}
svg {
border-width:0px;
background: #fff;
grid-column: 1 / 2;
  grid-row: 2 / 2;
}



</style>
<script src="d3.min.js"></script>
<script src="d3-save-svg-min.js"></script>

<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>



<body>
        <button id="generate">Save as SVG</button>
        <button id="redraw">Redraw</button>
        <form id="jsonform">
            <textarea id="jsontextarea"></textarea>
            <textarea id="jsontextarea2"></textarea>

        </form>

        <script>
                var nodesObj;
                var linksObj;
                // Setup SVG
                var width = 600, height = 600;
                var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height);

                
                // Setup initial data
                nodesObj = [
                    {"id": "Topkring", "radius": 50, x:0,y:0},
                    {"id": "Schoolkring", "radius": 100,x:0,y:0},
                    {"id": "Ouderkring", "radius": 70,x:0,y:0},
                    {"id": "Stafkring", "radius": 50,x:0,y:0},
                    {"id": "Bemiddelingskring", "radius": 75,x:0,y:0}
                  ];

                linksObj = [
                    { "source": "Topkring", "target": "Schoolkring", "type": "double" },
                    { "source": "Topkring", "target": "Ouderkring", "type": "double" },
                    { "source": "Topkring", "target": "Stafkring", "type": "single" },
                    { "source": "Schoolkring", "target": "Bemiddelingskring", "type": "double" }
                  ]
                var simulation;

                function doIt(){
                svgPrepare();
                updateTextAreaFromObjects();
                updateLinksTextArea(linksObj);
                // Force simulation
                
                const forceX = d3.forceX(width / 2).strength(1)
                const forceY = d3.forceY(height / 2).strength(1)
                
                simulation = d3.forceSimulation()
                  .force('charge', d3.forceManyBody().strength(-50))
                  .force('center', d3.forceCenter(width / 2, height / 2))
                  .force('collision', d3.forceCollide().radius(function(d) {return d.radius}))
                  .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(180))
                  .on("tick", ticked);

                simulation.nodes(nodesObj);
                simulation.force("link").links(linksObj);
         

                // draw svg shapes

                var link = d3.select("#links").selectAll(".link"),
                    node = d3.select("#nodes").selectAll(".node"),
                    text = d3.select("#text").selectAll("text");
                
                  link = link
                    .data(linksObj)
                    .enter().append("path")
                      .attr("class", "link")
                      .attr("marker-end", "url(#endArrow)");
                
                  node = node
                    .data(nodesObj)
                    .enter().append("circle")
                      .attr("class", "node")
                      .attr("r", function(d) { return d.radius; })
                      .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));
                    
                    text = text
                        .data(nodesObj)
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x; })
                        .attr("y", function(d) { return d.y; })
                        .text( function (d) { return d.id; })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", function(d){return fontSize(d.id,d.radius);})
                        .attr("alignment-baseline","middle")
                        .attr("text-anchor","middle");
                
                // Drag callbacks
                
                function fontSize(s,rad){
                  var n = (250 / s.length)*(rad/100);
                  n = Math.max(n, 5);
                  n = Math.min(n,20);

                  return ""+n+"px";
                }
                function dragstarted(d) {
                  d3.select(this).raise().classed("active", true);
                }
                
                function dragged(d) {
                  d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
                  ticked();
                }
                
                function dragended(d) {
                  d3.select(this).classed("active", false);
                  updateTextAreaFromObjects();
                }
                
                function ticked() {

                  node.attr("cx", function(d) { return d.x; })
                      .attr("cy", function(d) { return d.y; });
                  text.attr("x", function(d) { return d.x; })
                      .attr("y", function(d) { return d.y; });
                  link.attr("d", function(d) {
                      // Total difference in x and y from source to target
                      diffX = parseFloat(d.target.x - d.source.x);
                      diffY = parseFloat(d.target.y - d.source.y);
          
                      // Length of path from center of source node to center of target node
                      pathLength = Math.sqrt((diffX * diffX) + (diffY * diffY));
          
                      // if we define dx=x2-x1 and dy=y2-y1, then the normals are (-dy, dx) and (dy, -dx).
                      var normalX = (-1*diffY) / pathLength;
                      var normalY = diffX / pathLength;
          
                      var offsetAmount=5.0;
                      xPerpOffset=normalX*offsetAmount;
                      yPerpOffset=normalY*offsetAmount;
          
                      var linkPadding = 5;
                      // x and y distances from center to outside edge of target node
                      offsetXt = (diffX * (d.target.radius + linkPadding)) / pathLength;
                      offsetYt = (diffY * (d.target.radius + linkPadding)) / pathLength;
                      offsetXs = (diffX * (d.source.radius + linkPadding)) / pathLength;
                      offsetYs = (diffY * (d.source.radius + linkPadding)) / pathLength;
                      var oStringd = "M " + d.source.x+ ",\n" + d.source.y + "\nL" + (d.target.x - offsetXt) + ",\n" + (d.target.y - offsetYt);
                      var dStringd = "\n\n M " + (d.source.x+xPerpOffset+offsetXs)+ ",\n" + d.source.y+yPerpOffset+offsetYs + "\nL" + ((d.target.x+xPerpOffset) - offsetXt) + ",\n" + ((d.target.y+yPerpOffset) - offsetYt);
          
                      var dString="";
                      if (d.type=="single"){
                          // draw a single link
                          dString = "M" + (d.source.x+offsetXs)+ "," + (d.source.y+offsetYs) + "L" + ((d.target.x) - offsetXt) + "," + ((d.target.y) - offsetYt);
                      } else {
                          // draw a double link
                          dString = "M" + (d.source.x+xPerpOffset+offsetXs)+ "," + (d.source.y+yPerpOffset+offsetYs) + "L" + ((d.target.x+xPerpOffset) - offsetXt) + "," + ((d.target.y+yPerpOffset) - offsetYt);
                          dString += "M" + (d.source.x-xPerpOffset+offsetXs)+ "," + (d.source.y-yPerpOffset+offsetYs) + "L" + ((d.target.x-xPerpOffset) - offsetXt) + "," + ((d.target.y-yPerpOffset) - offsetYt);
                      }
                      // alert (oStringd + dStringd);
                      return dString;
                    }).attr("marker-end", "url(#endArrow)").attr("marker-start", "url(#startArrow)");
                }
            }
                d3.select('button#generate').on('click', function() {
                  var config = {
                    filename: 'circles',
                  }
                  d3_save_svg.save(d3.select('svg').node(), config);
                });
                d3.select('button#redraw').on('click', function() {
                    try {
                    nodesObj = JSON.parse(d3.select("#jsontextarea").property('value')); // this is how you parse a string into JSON 
                    linksObj = JSON.parse(d3.select("#jsontextarea2").property('value')); // this is how you parse a string into JSON 
                    svg.selectAll("*").remove();
                    simulation.stop();
                    doIt(true);
                    } catch (ex) {
                    console.error(ex);
                    }
                });
                
                function updateObjectFromTextArea(){

                  var s = d3.select("#jsontextarea").property('value')
                  nodesObj = JSON.parse(d3.select("#jsontextarea").property('value')); // this is how you parse a string into JSON 
                  linksObj = JSON.parse(d3.select("#jsontextarea2").property('value')); // this is how you parse a string into JSON 

                }
                function updateTextAreaFromObjects(){
                  var myJSON = JSON.stringify(nodesObj,replacer,2);
                  d3.select("#jsontextarea").text(myJSON);
                }
                function updateLinksTextArea(o){
                  var myJSON = JSON.stringify(o,replacer,2);
                  d3.select("#jsontextarea2").text(myJSON);
                }

                function svgPrepare(){
                  var svg = d3.select("svg"),
                    width = +svg.attr("width"),
                    height = +svg.attr("height");
                    var svglinks = svg.append("g").attr("id", "links");
                    var svgnodes = svg.append("g").attr("id", "nodes");
                    var svgtext = svg.append("g").attr("id", "text");
                
                // Per-type markers, as they don't inherit styles.
                svg.append("defs").selectAll("marker")
                    .data(["endArrow"])
                  .enter().append("marker")
                    .attr("id", function(d) { return d; })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 10)
                    .attr("refY", 0)
                    .attr("color", "red")
                
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("path")
                    .attr("d", "M0,-5L10,0L0,5");
                
                svg.append("defs").selectAll("marker")
                    .data(["startArrow"])
                  .enter().append("marker")
                    .attr("id", function(d) { return d; })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 0)
                    .attr("refY", 0)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("path")
                  .attr("d", "M10,-5L0,0L10,5");
                }

                function replacer(key,value)
                {
                    if (key=="vx"||key=="vy"||key=="index") return undefined;
                    else if (key=="privateProperty2") return undefined;
                    else return value;
                }

                doIt();
                </script>
</body>