<!DOCTYPE html>
<meta charset="utf-8">
<style>
body{
    background: #eee;   
    display: grid;
    grid-template-columns: [first] 800px [line2] auto [end];
    grid-template-rows: [row1-start] 100px [row1-end] 820px [third-line] auto [last-line];

}
.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

circle.node {
  fill: rgba(236, 234, 234, 1);
  stroke: #fff;
  stroke-width: 1.5px;
}

text {
  font: 14px sans-serif;
  pointer-events: none;
}
button#generate{
  grid-column: 1 / 2;
  grid-row: 1 / 1;
}
button#redraw{
  grid-column: 2 / 3;
  grid-row: 1 / 1;
}
textarea#jsontextarea{
  grid-column: 2 / 3;
  grid-row: 2 / 3;
  width:100%;
  height:100%;
}
svg {
border-width:0px;
background: #fff;
grid-column: 1 / 2;
  grid-row: 2 / 2;
}



</style>
<script src="d3.min.js"></script>
<script src="d3-save-svg-min.js"></script>

<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-drag.v1.min.js"></script>



<body>
        <button id="generate">Save as SVG</button>
        <button id="redraw">Redraw</button>
        <form id="jsonform">
            <textarea id="jsontextarea"></textarea>
        </form>

        <script>
                var width = 800, height = 800;
                var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height);
                
                
                var graph = {
                  "nodes": [
                    {"id": "Topkring", "radius": 50},
                    {"id": "Schoolkring", "radius": 100},
                    {"id": "Ouderkring", "radius": 70},
                    {"id": "Stafkring", "radius": 50},
                    {"id": "Bemiddelingskring", "radius": 50}
                  ],
                  "links": [
                    { "source": "Topkring", "target": "Schoolkring", "type": "double" },
                    { "source": "Topkring", "target": "Ouderkring", "type": "double" },
                    { "source": "Topkring", "target": "Stafkring", "type": "single" },
                    { "source": "Schoolkring", "target": "Bemiddelingskring", "type": "double" }
                  ]
                }

                function doIt(g){
                var myJSON = JSON.stringify(g,null,2);
                d3.select("#jsontextarea").text(myJSON);

                var svg = d3.select("svg"),
                    width = +svg.attr("width"),
                    height = +svg.attr("height");
                    var svglinks = svg.append("g").attr("id", "links");
                    var svgnodes = svg.append("g").attr("id", "nodes");
                    var svgtext = svg.append("g").attr("id", "text");
                
                // Per-type markers, as they don't inherit styles.
                svg.append("defs").selectAll("marker")
                    .data(["endArrow"])
                  .enter().append("marker")
                    .attr("id", function(d) { return d; })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 10)
                    .attr("refY", 0)
                    .attr("color", "red")
                
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("path")
                    .attr("d", "M0,-5L10,0L0,5");
                
                svg.append("defs").selectAll("marker")
                    .data(["startArrow"])
                  .enter().append("marker")
                    .attr("id", function(d) { return d; })
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 0)
                    .attr("refY", 0)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                  .append("path")
                  .attr("d", "M10,-5L0,0L10,5");
                
                const forceX = d3.forceX(width / 2).strength(0.055)
                const forceY = d3.forceY(height / 2).strength(0.055)
                
                var simulation = d3.forceSimulation()
                    .force("charge", d3.forceManyBody().strength(-700))
                    .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(220))
                    .force("x", d3.forceX(width / 4))
                    .force("y", d3.forceY(height / 4))
                    .on("tick", ticked)
                    .force('x', forceX)
                    .force('y',  forceY);
                
                var link = svglinks.selectAll(".link"),
                    node = svgnodes.selectAll(".node"),
                    text = svgtext.selectAll("text");
                
                // d3.json("graph.json", function(error, graph) {
                //   if (error) throw error;
                
                  simulation.nodes(g.nodes);
                  simulation.force("link").links(g.links);
                
                  link = link
                    .data(g.links)
                    .enter().append("path")
                      .attr("class", "link")
                      .attr("marker-end", "url(#endArrow)");
                //      .attr("marker-start", "url(#suit)");
                
                
                // svglinks.selectAll(".link") .attr("marker-end", "url(#end)");
                
                  node = node
                    .data(g.nodes)
                    .enter().append("circle")
                      .attr("class", "node")
                      .attr("r", function(d) { return d.radius; })
                      .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));
                    
                    text = text
                        .data(g.nodes)
                        .enter()
                        .append("text")
                        .attr("x", function(d) { return d.x; })
                        .attr("y", function(d) { return d.y; })
                        .text( function (d) { return d.id; })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "20px")
                        .attr("alignment-baseline","middle")
                        .attr("text-anchor","middle");
                
                function dragstarted(d) {
                  d3.select(this).raise().classed("active", true);
                }
                
                function dragged(d) {
                  d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
                  ticked();
                }
                
                function dragended(d) {
                  d3.select(this).classed("active", false);
                }
                
                function ticked() {
                    link.attr("d", function(d) {
                            // Total difference in x and y from source to target
                            diffX = parseFloat(d.target.x - d.source.x);
                            diffY = parseFloat(d.target.y - d.source.y);
                
                            // Length of path from center of source node to center of target node
                            pathLength = Math.sqrt((diffX * diffX) + (diffY * diffY));
                
                            // if we define dx=x2-x1 and dy=y2-y1, then the normals are (-dy, dx) and (dy, -dx).
                            var normalX = (-1*diffY) / pathLength;
                            var normalY = diffX / pathLength;
                
                            var offsetAmount=5.0;
                            xPerpOffset=normalX*offsetAmount;
                            yPerpOffset=normalY*offsetAmount;
                
                            var linkPadding = 5;
                            // x and y distances from center to outside edge of target node
                            offsetXt = (diffX * (d.target.radius + linkPadding)) / pathLength;
                            offsetYt = (diffY * (d.target.radius + linkPadding)) / pathLength;
                            offsetXs = (diffX * (d.source.radius + linkPadding)) / pathLength;
                            offsetYs = (diffY * (d.source.radius + linkPadding)) / pathLength;
                            var oStringd = "M " + d.source.x+ ",\n" + d.source.y + "\nL" + (d.target.x - offsetXt) + ",\n" + (d.target.y - offsetYt);
                            var dStringd = "\n\n M " + (d.source.x+xPerpOffset+offsetXs)+ ",\n" + d.source.y+yPerpOffset+offsetYs + "\nL" + ((d.target.x+xPerpOffset) - offsetXt) + ",\n" + ((d.target.y+yPerpOffset) - offsetYt);
                
                            var dString="";
                            if (d.type=="single"){
                                // draw a single link
                                dString = "M" + (d.source.x+offsetXs)+ "," + (d.source.y+offsetYs) + "L" + ((d.target.x) - offsetXt) + "," + ((d.target.y) - offsetYt);
                            } else {
                                // draw a double link
                                dString = "M" + (d.source.x+xPerpOffset+offsetXs)+ "," + (d.source.y+yPerpOffset+offsetYs) + "L" + ((d.target.x+xPerpOffset) - offsetXt) + "," + ((d.target.y+yPerpOffset) - offsetYt);
                                dString += "M" + (d.source.x-xPerpOffset+offsetXs)+ "," + (d.source.y-yPerpOffset+offsetYs) + "L" + ((d.target.x-xPerpOffset) - offsetXt) + "," + ((d.target.y-yPerpOffset) - offsetYt);
                            }
                            // alert (oStringd + dStringd);
                            return dString;
                        }).attr("marker-end", "url(#endArrow)").attr("marker-start", "url(#startArrow)")
                        
                        ;
                
                
                    node.attr("cx", function(d) { return d.x; })
                      .attr("cy", function(d) { return d.y; });
                    text
                        .attr("x", function(d) { return d.x; })
                        .attr("y", function(d) { return d.y; });
                
                
                }
            }
                d3.select('button#generate').on('click', function() {
                  var config = {
                    filename: 'circles',
                  }
                  d3_save_svg.save(d3.select('svg').node(), config);
                });
                d3.select('button#redraw').on('click', function() {
                    try {
                    var g = JSON.parse(d3.select("#jsontextarea").property('value')); // this is how you parse a string into JSON 
                    svg.selectAll("*").remove();
                    console.log(g);
                    doIt(g);
                    } catch (ex) {
                    console.error(ex);
                    }
                });
                doIt(graph);

                </script>
</body>